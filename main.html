<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Snap & Learn AI</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root {
      --brand: #8B5CF6;
      --brand-600: #7C3AED;
      --brand-700: #6D28D9;
    }
    html, body { height: 100%; }
    body { font-family: 'Inter', sans-serif; }
    /* Background */
    .app-bg {
      background:
        radial-gradient(1000px 400px at 10% 0%, rgba(139,92,246,.12), transparent 60%),
        radial-gradient(1000px 600px at 100% 0%, rgba(99,102,241,.10), transparent 60%),
        linear-gradient(180deg, #0b1020 0%, #0b1020 100%);
    }
    .light .app-bg { background: linear-gradient(180deg, #f8fafc, #f3f4f6); }

    /* Slightly darker dark mode background (subtle) */
    .dark .app-bg {
      background:
        radial-gradient(1000px 400px at 10% 0%, rgba(99,102,241,.14), transparent 60%),
        radial-gradient(1000px 600px at 100% 0%, rgba(168,85,247,.08), transparent 60%),
        linear-gradient(180deg, #060612 0%, #0b1020 100%);
    }

    /* Glass cards */
    .glass { backdrop-filter: blur(12px); background: rgba(255,255,255,0.75); }
    .dark .glass { background: rgba(15,23,42,.6); color: #e5e7eb; }

    /* Tabs */
    .tab-btn.active {
      color: var(--brand);
      background-color: rgba(139,92,246, .10);
      border-color: var(--brand);
      transform: translateY(-1px) scale(1.02);
    }

    /* Fun bounce */
    .fun-bounce { animation: funBounce .9s ease-in-out infinite alternate; }
    @keyframes funBounce { from { transform: translateY(0) } to { transform: translateY(-4px) } }

    /* Loaders */
    .loader { border: 4px solid #e5e7eb; border-top: 4px solid var(--brand);
      border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg) } }

    /* Focus ring */
    .focus-ring:focus-visible { outline: 3px solid rgba(139,92,246,.5); outline-offset: 2px; }

    /* Toasts */
    .toast { animation: slideIn .25s ease, fadeOut .25s ease 3.5s forwards; }
    @keyframes slideIn { from { transform: translateY(8px); opacity: 0 } to { transform: translateY(0); opacity: 1 } }
    @keyframes fadeOut { to { opacity: 0; transform: translateY(-6px) } }

    /* Cute pulse */
    .pulse-once { animation: pulseOnce .7s ease; }
    @keyframes pulseOnce {
      0% { transform: scale(.98) }
      50% { transform: scale(1.02) }
      100% { transform: scale(1) }
    }

    /* Confetti canvas */
    #confettiCanvas { pointer-events: none; position: fixed; inset: 0; z-index: 60; }

    /* In dark mode, make user input fields readable (black text + light bg) */
    .dark textarea,
    .dark input[type="text"],
    .dark input[type="file"] {
      color: #000 !important;
      background-color: #f3f4f6 !important;
    }

    /* Floating help tooltip */
    #helpTooltip {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(135deg,#8B5CF6,#7C3AED);
      color: white;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
      font-weight: 700;
      z-index: 70;
    }
    #helpContent {
      position: fixed;
      bottom: 82px;
      right: 20px;
      background: white;
      color: #0b1020;
      padding: 14px;
      border-radius: 12px;
      width: 280px;
      font-size: 13px;
      display: none;
      box-shadow: 0 8px 28px rgba(2,6,23,0.2);
      z-index: 70;
    }
    #helpContent h4 { margin: 0 0 6px 0; font-weight: 700; font-size: 14px;}
    #helpContent p { margin: 4px 0; line-height:1.28; }
    
    /* Tic-Tac-Toe Game styles */
    .game-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-gap: 8px;
        width: min(100%, 300px);
        margin: 20px auto;
    }
    .game-cell {
        width: 100px;
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        font-weight: bold;
        color: var(--brand);
        background-color: rgba(255, 255, 255, 0.5);
        border: 2px solid var(--brand);
        border-radius: 12px;
        cursor: pointer;
        transition: transform 0.1s ease, background-color 0.2s;
    }
    .dark .game-cell {
        background-color: rgba(15, 23, 42, 0.6);
        color: #e5e7eb;
    }
    .game-cell:hover:not(:disabled) {
        transform: scale(1.05);
        background-color: rgba(139, 92, 246, 0.1);
    }
    .game-cell:disabled {
        cursor: not-allowed;
    }

    /* Memory Game styles */
    .memory-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      width: min(100%, 420px);
      margin: 20px auto;
    }
    .memory-card {
      width: 100px;
      height: 100px;
      background-color: var(--brand);
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      cursor: pointer;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }
    .memory-card.flipped { transform: rotateY(180deg); }
    .memory-card.match { opacity: 0.5; cursor: default; }
    .memory-card.generated-card {
        background-color: #e5e7eb;
        color: #1f2937;
        font-size: 1rem;
        font-weight: 500;
        padding: 10px;
        text-align: center;
        box-shadow: none;
    }

    .card-face, .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      font-weight: bold;
      border-radius: 12px;
    }
    .card-face {
      transform: rotateY(180deg);
      background-color: white;
    }
    .card-back {
      background: linear-gradient(135deg, var(--brand-600), var(--brand-700));
      color: white;
    }
  </style>
</head>

<body class="app-bg text-slate-800 dark:text-slate-100 light">
  <canvas id="confettiCanvas" class="hidden"></canvas>
  <div class="min-h-screen">

    <!-- Header -->
    <header class="sticky top-0 z-30 border-b border-slate-200/50 dark:border-slate-700/60 bg-white/70 dark:bg-slate-900/70 backdrop-blur">
      <div class="mx-auto max-w-5xl px-4 md:px-6 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-xl bg-gradient-to-tr from-indigo-500 via-violet-500 to-fuchsia-500 shadow ring-1 ring-white/30 grid place-items-center fun-bounce">
            <i data-lucide="aperture" class="h-5 w-5 text-white"></i>
          </div>
          <div>
            <h1 class="text-lg md:text-xl font-extrabold tracking-tight text-violet-700 dark:text-violet-300">
              Snap & Learn AI <span>üì∏‚ú®</span>
            </h1>
            <p class="text-xs md:text-sm text-slate-500 dark:text-slate-400 -mt-0.5">Your pocket-sized genius for instant knowledge.</p>
          </div>
        </div>

        <!-- Celebrate + Game + Theme toggles -->
        <div class="flex items-center gap-3">
          <button id="celebrateBtn" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-gradient-to-r from-pink-500 to-violet-500 text-white font-semibold shadow hover:scale-105 transition focus-ring">
            üéâ Celebrate
          </button>
          <button id="tab-games-header-btn" class="flex items-center gap-2 text-xs px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition focus-ring" aria-label="Play a game">
            <i data-lucide="gamepad-2" class="h-4 w-4"></i>
            <span class="hidden md:inline">Games</span>
          </button>
          <button id="themeToggle" class="flex items-center gap-2 text-xs px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition focus-ring" aria-label="Toggle theme">
            <i data-lucide="moon-star" class="h-4 w-4 block dark:hidden"></i>
            <i data-lucide="sun" class="h-4 w-4 hidden dark:block"></i>
            <span class="hidden md:inline">Theme</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="mx-auto max-w-5xl p-4 md:p-8">
      <div class="glass rounded-2xl shadow-xl ring-1 ring-slate-900/5 dark:ring-white/10">
        <div class="px-4 md:px-6 pt-4 md:pt-6">
          <div class="grid grid-cols-4 gap-2 md:gap-3 border-b border-slate-200 dark:border-slate-700 pb-3">
            <button id="tab-ar" class="tab-btn group flex items-center justify-center gap-2 py-3 text-sm md:text-base font-semibold rounded-xl border-2 border-transparent transition focus-ring active">
              <i data-lucide="sparkles" class="h-5 w-5"></i>
              <span>AR Teacher</span>
            </button>
            <button id="tab-notes" class="tab-btn group flex items-center justify-center gap-2 py-3 text-sm md:text-base font-semibold rounded-xl border-2 border-transparent transition focus-ring">
              <i data-lucide="notebook-text" class="h-5 w-5"></i>
              <span>SnapNotes</span>
            </button>
            <button id="tab-quiz" class="tab-btn group flex items-center justify-center gap-2 py-3 text-sm md:text-base font-semibold rounded-xl border-2 border-transparent transition focus-ring">
              <i data-lucide="file-question" class="h-5 w-5"></i>
              <span>Quiz Me</span>
            </button>
            <button id="tab-meme" class="tab-btn group flex items-center justify-center gap-2 py-3 text-sm md:text-base font-semibold rounded-xl border-2 border-transparent transition focus-ring">
              <i data-lucide="laugh" class="h-5 w-5"></i>
              <span>Gen Z Mode</span>
            </button>
          </div>
        </div>

        <!-- AR Teacher -->
        <section id="panel-ar" class="tab-panel px-4 md:px-6 pb-6 md:pb-8">
          <div class="text-center mt-6">
            <h2 class="text-2xl md:text-3xl font-bold tracking-tight">Snap & Learn an Object</h2>
            <p class="text-slate-500 dark:text-slate-400 mt-2">Upload a photo, PDF, or type text to learn about it.</p>
          </div>

          <div class="mt-6 grid gap-4">
            <div>
              <div class="flex items-center justify-between mb-2">
                <label for="ar-input" class="text-sm font-medium">Text (optional)</label>
                <span id="ar-count" class="text-xs text-slate-500">0 chars</span>
              </div>
              <textarea id="ar-input" class="w-full h-36 p-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/40 focus:ring-2 focus:ring-violet-500 focus:border-transparent transition" placeholder="Paste or type text here..."></textarea>
            </div>

            <!-- Drag & Drop -->
            <div id="ar-drop" class="relative w-full max-w-xl mx-auto">
              <div class="w-full bg-slate-50 dark:bg-slate-900/30 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-2xl p-8 text-center cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800/50 transition" onclick="document.getElementById('imageUpload-ar').click()">
                <input type="file" id="imageUpload-ar" class="hidden" accept="image/*,.pdf" onchange="handleFileUpload('ar', event)">
                <div id="file-placeholder-ar" class="space-y-3">
                  <i data-lucide="upload-cloud" class="h-10 w-10 mx-auto text-slate-400"></i>
                  <p class="text-sm text-slate-600 dark:text-slate-300">
                    <span class="font-semibold">Click to upload</span> or drag & drop an image or PDF
                  </p>
                  <p class="text-xs text-slate-400">Images (JPG/PNG) or PDF up to ~10MB</p>
                </div>
                <img id="uploadedImage-ar" class="hidden max-h-64 mx-auto rounded-xl shadow" alt="Uploaded object">
              </div>
            </div>
          </div>

          <div class="text-center flex justify-center items-center gap-4">
            <button id="analyzeBtn" class="mt-6 inline-flex items-center gap-2 bg-violet-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-violet-700 active:scale-[.99] transition disabled:bg-slate-400 disabled:cursor-not-allowed focus-ring" disabled>
              <i data-lucide="wand-2" class="h-5 w-5"></i>
              <span>Explain this</span>
            </button>
             <button id="ar-gen-game-btn" class="mt-6 inline-flex items-center gap-2 bg-pink-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-pink-700 active:scale-[.99] transition focus-ring" disabled>
              <i data-lucide="gamepad-2" class="h-5 w-5"></i>
              <span>Generate Game</span>
            </button>
          </div>

          <div id="ar-results-container" class="mt-8 hidden">
            <div class="mx-auto loader hidden" id="ar-loader" aria-label="Loading"></div>

            <div class="bg-violet-50/70 dark:bg-violet-950/20 border border-violet-200 dark:border-violet-900/50 rounded-2xl p-5 relative pulse-once" id="ar-analysis-result">
              <button class="copy-btn absolute top-3 right-3 text-xs px-2.5 py-1.5 rounded-lg border border-slate-200/70 dark:border-slate-700/70 hover:bg-white/50 dark:hover:bg-slate-800/60 transition focus-ring" data-target="ar-analysis-result">
                <i data-lucide="copy" class="h-4 w-4"></i>
              </button>
            </div>
          </div>
        </section>

        <!-- SnapNotes -->
        <section id="panel-notes" class="tab-panel hidden px-4 md:px-6 pb-6 md:pb-8">
          <div class="text-center mt-6">
            <h2 class="text-2xl md:text-3xl font-bold tracking-tight">Summarize Your Notes</h2>
          </div>

          <div class="mt-6 grid gap-4">
            <div>
              <div class="flex items-center justify-between mb-2">
                <label for="notes-input" class="text-sm font-medium">Notes</label>
                <span id="notes-count" class="text-xs text-slate-500">0 chars</span>
              </div>
              <textarea id="notes-input" class="w-full h-36 p-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/40 focus:ring-2 focus:ring-violet-500 focus:border-transparent transition" placeholder="Paste or type your notes here..."></textarea>
            </div>

            <div class="flex items-center gap-3 flex-wrap">
              <label for="notes-file-upload" class="cursor-pointer inline-flex items-center gap-2 bg-slate-100 dark:bg-slate-800/60 text-slate-800 dark:text-slate-100 py-2.5 px-4 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-800 transition focus-ring">
                <i data-lucide="paperclip" class="h-4 w-4"></i>
                <span id="notes-file-label">Upload PDF or Photo</span>
                <input type="file" id="notes-file-upload" class="hidden" accept=".pdf,image/*" onchange="handleFileUpload('notes', event)">
              </label>
              <span id="notes-file-name" class="text-sm text-slate-500">No file chosen</span>
            </div>

            <div id="notes-image-preview-container" class="hidden text-center">
              <img id="notes-image-preview" class="max-h-64 mx-auto mt-4 rounded-xl shadow" alt="Uploaded image for notes">
            </div>
          </div>

          <div class="text-center flex justify-center items-center gap-4">
            <button id="summarizeBtn" class="mt-6 inline-flex items-center gap-2 bg-violet-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-violet-700 active:scale-[.99] transition disabled:bg-slate-400 disabled:cursor-not-allowed focus-ring" disabled>
              <i data-lucide="list-checks" class="h-5 w-5"></i>
              <span>Summarize Notes</span>
            </button>
             <button id="notes-gen-game-btn" class="mt-6 inline-flex items-center gap-2 bg-pink-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-pink-700 active:scale-[.99] transition focus-ring" disabled>
              <i data-lucide="gamepad-2" class="h-5 w-5"></i>
              <span>Generate Game</span>
            </button>
          </div>

          <div id="notes-results-container" class="mt-8 hidden">
            <div id="notes-loader" class="mx-auto loader hidden"></div>
            <div id="notes-summary-result" class="bg-violet-50/70 dark:bg-violet-950/20 border border-violet-200 dark:border-violet-900/50 rounded-2xl p-5 relative pulse-once">
              <button class="copy-btn absolute top-3 right-3 text-xs px-2.5 py-1.5 rounded-lg border border-slate-200/70 dark:border-slate-700/70 hover:bg-white/50 dark:hover:bg-slate-800/60 transition focus-ring" data-target="notes-summary-result">
                <i data-lucide="copy" class="h-4 w-4"></i>
              </button>
            </div>
          </div>
        </section>

        <!-- Quiz Me -->
        <section id="panel-quiz" class="tab-panel hidden px-4 md:px-6 pb-6 md:pb-8">
          <div class="text-center mt-6">
            <h2 class="text-2xl md:text-3xl font-bold tracking-tight">Generate a Quiz</h2>
          </div>

          <div class="mt-6 grid gap-4">
            <div>
              <div class="flex items-center justify-between mb-2">
                <label for="quiz-input" class="text-sm font-medium">Source Text</label>
                <span id="quiz-count" class="text-xs text-slate-500">0 chars</span>
              </div>
              <textarea id="quiz-input" class="w-full h-36 p-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/40 focus:ring-2 focus:ring-violet-500 focus:border-transparent transition" placeholder="Paste any text here to create a quiz..."></textarea>
            </div>

            <div class="flex items-center gap-3 flex-wrap">
              <label for="quiz-file-upload" class="cursor-pointer inline-flex items-center gap-2 bg-slate-100 dark:bg-slate-800/60 text-slate-800 dark:text-slate-100 py-2.5 px-4 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-800 transition focus-ring">
                <i data-lucide="paperclip" class="h-4 w-4"></i>
                <span id="quiz-file-label">Upload PDF or Photo</span>
                <input type="file" id="quiz-file-upload" class="hidden" accept=".pdf,image/*" onchange="handleFileUpload('quiz', event)">
              </label>
              <span id="quiz-file-name" class="text-sm text-slate-500">No file chosen</span>
            </div>

            <div id="quiz-image-preview-container" class="hidden text-center">
              <img id="quiz-image-preview" class="max-h-64 mx-auto mt-4 rounded-xl shadow" alt="Uploaded image for quiz">
            </div>
          </div>

          <div class="text-center flex justify-center items-center gap-4">
            <button id="quizBtn" class="mt-6 inline-flex items-center gap-2 bg-violet-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-violet-700 active:scale-[.99] transition disabled:bg-slate-400 disabled:cursor-not-allowed focus-ring" disabled>
              <i data-lucide="sparkle" class="h-5 w-5"></i>
              <span>Create Quiz</span>
            </button>
            <button id="quiz-gen-game-btn" class="mt-6 inline-flex items-center gap-2 bg-pink-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-pink-700 active:scale-[.99] transition focus-ring" disabled>
              <i data-lucide="gamepad-2" class="h-5 w-5"></i>
              <span>Generate Game</span>
            </button>
          </div>

          <div id="quiz-results-container" class="mt-8 hidden">
            <div id="quiz-loader" class="mx-auto loader hidden"></div>
            <div id="quiz-result" class="bg-violet-50/70 dark:bg-violet-950/20 border border-violet-200 dark:border-violet-900/50 rounded-2xl p-5 relative pulse-once">
              <button class="copy-btn absolute top-3 right-3 text-xs px-2.5 py-1.5 rounded-lg border border-slate-200/70 dark:border-slate-700/70 hover:bg-white/50 dark:hover:bg-slate-800/60 transition focus-ring" data-target="quiz-result">
                <i data-lucide="copy" class="h-4 w-4"></i>
              </button>
            </div>
          </div>
        </section>

        <!-- Gen Z Mode -->
        <section id="panel-meme" class="tab-panel hidden px-4 md:px-6 pb-6 md:pb-8">
          <div class="text-center mt-6">
            <h2 class="text-2xl md:text-3xl font-bold">Gen Z Mode ü§£</h2>
            <p class="text-slate-500 dark:text-slate-400 mt-2">Generate a meme or a fun fact about your content.</p>
          </div>
          <div class="mt-6 grid gap-4">
            <textarea id="meme-input" class="w-full h-36 p-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/40 focus:ring-2 focus:ring-violet-500 focus:border-transparent transition" placeholder="Paste text or upload a file..."></textarea>
            <div class="flex items-center gap-3 flex-wrap">
              <label for="meme-file-upload" class="cursor-pointer inline-flex items-center gap-2 bg-slate-100 dark:bg-slate-800/60 text-slate-800 dark:text-slate-100 py-2.5 px-4 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-800 transition focus-ring">
                <i data-lucide="paperclip" class="h-4 w-4"></i>
                <span id="meme-file-label">Upload PDF or Photo</span>
                <input type="file" id="meme-file-upload" class="hidden" accept=".pdf,image/*" onchange="handleFileUpload('meme', event)">
              </label>
              <span id="meme-file-name" class="text-sm text-slate-500">No file chosen</span>
            </div>
            <div id="meme-image-preview-container" class="hidden text-center">
              <img id="meme-image-preview" class="max-h-64 mx-auto mt-4 rounded-xl shadow" alt="Uploaded image for meme">
            </div>
          </div>
          <div class="text-center">
            <button id="memeBtn" class="mt-6 inline-flex items-center gap-2 bg-pink-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-pink-700 active:scale-[.99] transition disabled:bg-slate-400 disabled:cursor-not-allowed focus-ring" disabled>
              <i data-lucide="laugh" class="h-5 w-5"></i>
              <span>Generate Meme</span>
            </button>
            <button id="funFactBtn" class="mt-6 ml-2 inline-flex items-center gap-2 bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 active:scale-[.99] transition focus-ring" disabled>
              <i data-lucide="star" class="h-5 w-5"></i>
              <span>Fun Fact</span>
            </button>
          </div>
          <div id="meme-results-container" class="mt-8 hidden">
            <div id="meme-loader" class="mx-auto loader hidden"></div>
            <div id="meme-result" class="bg-pink-50/70 dark:bg-pink-900/20 border border-pink-200/70 dark:border-pink-900/50 rounded-2xl p-5 relative pulse-once">
              <button class="copy-btn absolute top-3 right-3 text-xs px-2.5 py-1.5 rounded-lg border border-slate-200/70 dark:border-slate-700/70 hover:bg-white/50 dark:hover:bg-slate-800/60 transition focus-ring" data-target="meme-result">
                <i data-lucide="copy" class="h-4 w-4"></i>
              </button>
            </div>
          </div>
          <div id="genz-summary-container" class="mt-8 hidden">
            <div id="genz-summary-loader" class="mx-auto loader hidden"></div>
            <div id="genz-summary-result" class="bg-emerald-50/70 dark:bg-emerald-900/20 border border-emerald-200/70 dark:border-emerald-900/50 rounded-2xl p-5 relative pulse-once"></div>
          </div>
        </section>

        <!-- Games -->
        <section id="panel-games" class="tab-panel hidden px-4 md:px-6 pb-6 md:pb-8">
          <div class="text-center mt-6">
            <h2 class="text-2xl md:text-3xl font-bold tracking-tight">Games Playground üïπÔ∏è</h2>
            <p class="text-slate-500 dark:text-slate-400 mt-2">Take a break and challenge yourself!</p>
          </div>

          <!-- Tic-Tac-Toe -->
          <div class="mt-8">
            <h3 class="text-xl md:text-2xl font-bold text-center">Tic-Tac-Toe</h3>
            <p id="tictactoe-status" class="text-slate-500 dark:text-slate-400 mt-2 text-center">Player X's turn.</p>
            <div class="game-grid">
              <button class="game-cell" data-cell-index="0"></button>
              <button class="game-cell" data-cell-index="1"></button>
              <button class="game-cell" data-cell-index="2"></button>
              <button class="game-cell" data-cell-index="3"></button>
              <button class="game-cell" data-cell-index="4"></button>
              <button class="game-cell" data-cell-index="5"></button>
              <button class="game-cell" data-cell-index="6"></button>
              <button class="game-cell" data-cell-index="7"></button>
              <button class="game-cell" data-cell-index="8"></button>
            </div>
            <div class="text-center mt-6">
              <button id="tictactoe-newGameBtn" class="inline-flex items-center gap-2 bg-violet-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-violet-700 active:scale-[.99] transition focus-ring">
                <i data-lucide="refresh-ccw" class="h-5 w-5"></i>
                <span>New Game</span>
              </button>
            </div>
          </div>

          <div class="h-px w-3/4 mx-auto my-8 bg-slate-300 dark:bg-slate-700"></div>

          <!-- Memory Game -->
          <div class="mt-8">
            <h3 class="text-xl md:text-2xl font-bold text-center">Memory Game</h3>
            <p id="memory-status" class="text-slate-500 dark:text-slate-400 mt-2 text-center">Find all the matching pairs!</p>
            <div id="memory-grid" class="memory-grid"></div>
            <div class="text-center mt-6">
              <button id="memory-newGameBtn" class="inline-flex items-center gap-2 bg-violet-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-violet-700 active:scale-[.99] transition focus-ring">
                <i data-lucide="refresh-ccw" class="h-5 w-5"></i>
                <span>New Game</span>
              </button>
            </div>
          </div>
        </section>
      </div>

      <footer class="text-center mt-10">
        <p class="text-xs text-slate-500 dark:text-slate-400">
          <strong>Disclaimer:</strong> AI-generated content is for educational purposes and may not be 100% accurate. Always verify important information.
        </p>
      </footer>
    </main>
  </div>

  <!-- Floating Help Tooltip -->
  <div id="helpTooltip">?</div>
  <div id="helpContent" role="dialog" aria-hidden="true">
    <h4>How to use</h4>
    <p>üì∏ <strong>AR Teacher</strong>: Upload/paste content and click <em>Explain this</em> to get Kid + Expert style explanations.</p>
    <p>üìù <strong>SnapNotes</strong>: Paste notes or upload a PDF/photo and click <em>Summarize</em> for quick bullet points.</p>
    <p>‚ùì <strong>Quiz Me</strong>: Generate a short multiple-choice quiz from your text or image.</p>
    <p>ü§£ <strong>Gen Z Mode</strong>: Get a funny meme caption or a fun fact about your content.</p>
    <p>üïπÔ∏è <strong>Games</strong>: Play classic Tic-Tac-Toe or a memory game to take a break!</p>
  </div>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <script>
    // --------------- Icons + Theme ---------------
    function refreshIcons(){ window.lucide && window.lucide.createIcons(); }
    document.addEventListener('DOMContentLoaded', refreshIcons);

    const rootEl = document.documentElement;
    const themeBtn = document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      if (savedTheme === 'dark') rootEl.classList.remove('light'), rootEl.classList.add('dark');
      if (savedTheme === 'light') rootEl.classList.remove('dark'), rootEl.classList.add('light');
    }
    themeBtn.addEventListener('click', () => {
      const isDark = rootEl.classList.toggle('dark');
      rootEl.classList.toggle('light', !isDark);
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      refreshIcons();
      toast(isDark ? 'Dark mode üåô' : 'Light mode ‚òÄÔ∏è', 'info');
    });

    // --------------- Toasts ---------------
    function toast(msg, type='info'){
      const wrap = document.getElementById('toastWrap') || (function(){ const w=document.createElement('div'); w.id='toastWrap'; w.className='fixed bottom-4 right-4 space-y-2 z-50'; document.body.appendChild(w); return w; })();
      const el = document.createElement('div');
      el.className = 'toast glass rounded-xl px-4 py-3 shadow ring-1 ring-slate-900/5 dark:ring-white/10 text-sm flex items-center gap-2';
      const icon = document.createElement('i');
      icon.setAttribute('data-lucide', type === 'error' ? 'alert-triangle' : 'info');
      icon.className = 'h-4 w-4';
      const span = document.createElement('span');
      span.textContent = msg;
      el.append(icon, span);
      wrap.appendChild(el);
      refreshIcons();
      setTimeout(() => el.remove(), 4000);
    }

    // --------------- PDF.js worker ---------------
    const workerScriptUrl = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    pdfjsLib.GlobalWorkerOptions.workerSrc = window.location.protocol === 'file:'
      ? URL.createObjectURL(new Blob([`importScripts('${workerScriptUrl}');`], { type: 'application/javascript' }))
      : workerScriptUrl;

    // --------------- Global State ---------------
    let arFileContent = { type: null, data: null };
    let notesFileContent = { type: null, data: null };
    let quizFileContent = { type: null, data: null };
    let memeFileContent = { type: null, data: null };

    // --------------- Tabs ---------------
    const tabs = document.querySelectorAll('.tab-btn');
    const panels = document.querySelectorAll('.tab-panel');
    const gamesHeaderBtn = document.getElementById('tab-games-header-btn');

    function switchPanels(targetPanelId) {
      tabs.forEach(t => t.classList.remove('active'));
      panels.forEach(p => p.classList.add('hidden'));
      const targetPanel = document.getElementById(targetPanelId);
      if (targetPanel) {
        targetPanel.classList.remove('hidden');
      }
      // Special handling for the games tab to reset the game
      if (targetPanelId === 'panel-games') {
        handleNewTictactoeGame();
        initMemoryGame();
      }
    }

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        switchPanels(`panel-${tab.id.split('-')[1]}`);
        tab.classList.add('active');
      });
    });

    gamesHeaderBtn.addEventListener('click', () => {
      switchPanels('panel-games');
      // No active state for the game button in the header, as it's not part of the tab bar
    });


    // --------------- Counters + enable buttons ---------------
    function updateCounter(id, counterId){
      const el = document.getElementById(id);
      const c  = document.getElementById(counterId);
      const v = el ? (el.value || '') : '';
      c && (c.textContent = `${v.length} chars`);
    }
    function checkInputAndEnableButton(context) {
      const textInput = document.getElementById(`${context}-input`);
      const fileContent =
        context === 'ar' ? arFileContent :
        context === 'notes' ? notesFileContent :
        context === 'quiz' ? quizFileContent :
        memeFileContent;
      const buttonId =
        context === 'ar' ? 'analyzeBtn' :
        context === 'notes' ? 'summarizeBtn' :
        context === 'quiz' ? 'quizBtn' : 'memeBtn';
      const gameButtonId = `${context}-gen-game-btn`;
      const button = document.getElementById(buttonId);
      const gameButton = document.getElementById(gameButtonId);
      
      const isDisabled = !((textInput && textInput.value.trim() !== '') || fileContent.data !== null);
      if (button) {
          button.disabled = isDisabled;
          button.setAttribute('aria-busy', String(!isDisabled));
      }

      if (gameButton) {
          gameButton.disabled = isDisabled;
          gameButton.setAttribute('aria-busy', String(!isDisabled));
      }
      
      const funFactButton = document.getElementById('funFactBtn');
      if (funFactButton) {
          const funFactDisabled = !((textInput && textInput.value.trim() !== '') || fileContent.data !== null);
          funFactButton.disabled = funFactDisabled;
          funFactButton.setAttribute('aria-busy', String(!funFactDisabled));
      }
    }
    ['ar','notes','quiz','meme'].forEach(ctx => {
      const input = document.getElementById(`${ctx}-input`);
      if (input) {
        input.addEventListener('input', () => {
          const cntId = `${ctx}-count`;
          if (document.getElementById(cntId)) updateCounter(`${ctx}-input`, cntId);
          checkInputAndEnableButton(ctx);
        });
      }
      const cntId = `${ctx}-count`;
      if (document.getElementById(cntId)) updateCounter(`${ctx}-input`, cntId);
    });

    // --------------- Drag & drop (AR) ---------------
    const arDrop = document.getElementById('ar-drop');
    const arInputFile = document.getElementById('imageUpload-ar');
    if (arDrop) {
      ['dragenter','dragover'].forEach(ev => {
        arDrop.addEventListener(ev, e => {
          e.preventDefault(); e.stopPropagation();
          arDrop.querySelector('div').classList.add('ring-2','ring-violet-400');
        });
      });
      ['dragleave','drop'].forEach(ev => {
        arDrop.addEventListener(ev, e => {
          e.preventDefault(); e.stopPropagation();
          arDrop.querySelector('div').classList.remove('ring-2','ring-violet-400');
        });
      });
      arDrop.addEventListener('drop', e => {
        const file = e.dataTransfer.files && e.dataTransfer.files[0];
        if (!file) return;
        const dt = new DataTransfer();
        dt.items.add(file);
        arInputFile.files = dt.files;
        handleFileUpload('ar', { target: arInputFile });
      });
    }

    // --------------- File Upload ---------------
    function handleFileUpload(context, event) {
      const file = event.target.files[0];
      const fileNameSpan = document.getElementById(`${context}-file-name`);
      const imagePreviewContainer = document.getElementById(`${context}-image-preview-container`);
      const imagePreview = document.getElementById(`${context}-image-preview`);
      const filePlaceholder = document.getElementById(`${context === 'ar' ? 'file-placeholder-ar' : `${context}-file-name`}`);
      const uploadedImage = document.getElementById(`${context === 'ar' ? 'uploadedImage-ar' : `${context}-image-preview`}`);

      if (!file) {
        if(context === 'ar') {
          uploadedImage && uploadedImage.classList.add('hidden');
          filePlaceholder && filePlaceholder.classList.remove('hidden');
        } else {
          fileNameSpan && (fileNameSpan.textContent = 'No file chosen');
          imagePreviewContainer && imagePreviewContainer.classList.add('hidden');
        }
        updateFileContent(context, null, null);
        checkInputAndEnableButton(context);
        return;
      }

      if(context === 'ar') {
        filePlaceholder && filePlaceholder.classList.add('hidden');
      } else {
        fileNameSpan && (fileNameSpan.textContent = file.name);
      }
      updateFileContent(context, null, null); // clear

      if (file.type === 'application/pdf') {
        if(context === 'ar') {
          uploadedImage && uploadedImage.classList.add('hidden');
        } else {
          imagePreviewContainer && imagePreviewContainer.classList.add('hidden');
        }
        const reader = new FileReader();
        reader.onload = async (e) => {
          const typedarray = new Uint8Array(e.target.result);
          try {
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();
              fullText += textContent.items.map(item => item.str).join(' ') + '\n';
            }
            updateFileContent(context, 'text', fullText);
            checkInputAndEnableButton(context);
            toast('PDF processed successfully');
          } catch (error) {
            toast('Failed to process PDF. Please try a different file.', 'error');
            console.error('PDF processing error:', error);
          }
        };
        reader.readAsArrayBuffer(file);

      } else if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          if(context === 'ar') {
            uploadedImage && (uploadedImage.src = e.target.result, uploadedImage.classList.remove('hidden'));
          } else {
            imagePreview && (imagePreview.src = e.target.result);
            imagePreviewContainer && imagePreviewContainer.classList.remove('hidden');
          }
          updateFileContent(context, 'image', e.target.result.split(',')[1]);
          checkInputAndEnableButton(context);
          toast('Image ready to analyze');
        };
        reader.readAsDataURL(file);

      } else {
        toast('Unsupported file type. Please upload a PDF or an image.', 'error');
        if(context === 'ar') {
          uploadedImage && uploadedImage.classList.add('hidden');
          filePlaceholder && filePlaceholder.classList.remove('hidden');
        } else {
          fileNameSpan && (fileNameSpan.textContent = 'No file chosen');
          imagePreviewContainer && imagePreviewContainer.classList.add('hidden');
        }
        updateFileContent(context, null, null);
        checkInputAndEnableButton(context);
      }
    }
    function updateFileContent(context, type, data) {
      if (context === 'ar') { arFileContent.type = type; arFileContent.data = data; }
      else if (context === 'notes') { notesFileContent.type = type; notesFileContent.data = data; }
      else if (context === 'quiz') { quizFileContent.type = type; quizFileContent.data = data; }
      else { memeFileContent.type = type; memeFileContent.data = data; }
    }

    // --------------- Actions ---------------
    // AR
    const arInput = document.getElementById('ar-input');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const arGenGameBtn = document.getElementById('ar-gen-game-btn');
    const arResultsContainer = document.getElementById('ar-results-container');
    const arLoader = document.getElementById('ar-loader');
    const arAnalysisResult = document.getElementById('ar-analysis-result');

    if (analyzeBtn) {
      analyzeBtn.addEventListener('click', async () => {
        const text = arInput.value.trim();
        if (!text && arFileContent.data === null) return;

        arResultsContainer.classList.remove('hidden');
        arLoader.classList.remove('hidden');
        arAnalysisResult.innerHTML = '';
        arAnalysisResult.classList.add('hidden');

        let prompt, imageData = null;
        if (arFileContent.type === 'image') {
          prompt = `Analyze the object in this image. Provide two explanations:
    1. **Kid Mode:** Explain it in a simple, fun, emoji-filled way a child can understand.
    2. **Expert Mode:** Provide a detailed, technical explanation with a professional tone.
    Format the response clearly with markdown.`;
          imageData = arFileContent.data;
        } else if (arFileContent.type === 'text') {
          prompt = `Analyze the following text. Provide two explanations:
    1. **Kid Mode:** Explain it in a simple, fun, emoji-filled way a child can understand.
    2. **Expert Mode:** Provide a detailed, technical explanation with a professional tone.
    Format the response clearly with markdown.

    Text:
    ${arFileContent.data}`;
        } else {
          prompt = `Analyze the following text. Provide two explanations:
    1. **Kid Mode:** Explain it in a simple, fun, emoji-filled way a child can understand.
    2. **Expert Mode:** Provide a detailed, technical explanation with a professional tone.
    Format the response clearly with markdown.

    Text:
    ${text}`;
        }

        try {
          const resultText = await callGeminiAPI(prompt, imageData);
          arAnalysisResult.innerHTML = formatResponse(resultText);
        } catch (error) {
          arAnalysisResult.innerHTML = `<p class="text-red-500">${error.message}</p>`;
        } finally {
          arLoader.classList.add('hidden');
          arAnalysisResult.classList.remove('hidden');
          confetti();
        }
      });
    }

    // Notes
    const notesInput = document.getElementById('notes-input');
    const summarizeBtn = document.getElementById('summarizeBtn');
    const notesGenGameBtn = document.getElementById('notes-gen-game-btn');
    const notesResultsContainer = document.getElementById('notes-results-container');
    const notesLoader = document.getElementById('notes-loader');
    const notesSummaryResult = document.getElementById('notes-summary-result');

    if (summarizeBtn) {
      summarizeBtn.addEventListener('click', async () => {
        const notes = notesInput.value.trim();
        if (!notes && notesFileContent.data === null) return;

        notesResultsContainer.classList.remove('hidden');
        notesLoader.classList.remove('hidden');
        notesSummaryResult.innerHTML = '';
        notesSummaryResult.classList.add('hidden');

        let prompt, imageData = null;
        if (notesFileContent.type === 'image') {
          prompt = `Summarize the contents of this image in bullet points.`;
          imageData = notesFileContent.data;
        } else if (notesFileContent.type === 'text') {
          prompt = `Summarize the following text in bullet points for quick revision:

    Text:
    ${notesFileContent.data}`;
        } else {
          prompt = `Summarize the following notes in bullet points for quick revision:

    Notes:
    ${notes}`;
        }

        try {
          const resultText = await callGeminiAPI(prompt, imageData);
          notesSummaryResult.innerHTML = formatResponse(resultText);
        } catch (error) {
          notesSummaryResult.innerHTML = `<p class="text-red-500">${error.message}</p>`;
        } finally {
          notesLoader.classList.add('hidden');
          notesSummaryResult.classList.remove('hidden');
          confetti();
        }
      });
    }

    // Quiz
    const quizInput = document.getElementById('quiz-input');
    const quizBtn = document.getElementById('quizBtn');
    const quizGenGameBtn = document.getElementById('quiz-gen-game-btn');
    const quizResultsContainer = document.getElementById('quiz-results-container');
    const quizLoader = document.getElementById('quiz-loader');
    const quizResult = document.getElementById('quiz-result');

    if (quizBtn) {
      quizBtn.addEventListener('click', async () => {
        const text = quizInput.value.trim();
        if (!text && quizFileContent.data === null) return;

        quizResultsContainer.classList.remove('hidden');
        quizLoader.classList.remove('hidden');
        quizResult.innerHTML = '';
        quizResult.classList.add('hidden');

        let prompt, imageData = null;
        if (quizFileContent.type === 'image') {
          prompt = `Based on the content of this image, generate a short quiz with 3 multiple-choice questions. For each question, provide 4 options (A, B, C, D) and indicate the correct answer.`;
          imageData = quizFileContent.data;
        } else if (quizFileContent.type === 'text') {
          prompt = `Based on the following text, generate a short quiz with 3 multiple-choice questions. For each question, provide 4 options (A, B, C, D) and indicate the correct answer.

    Text:
    ${quizFileContent.data}`;
        } else {
          prompt = `Based on the following text, generate a short quiz with 3 multiple-choice questions. For each question, provide 4 options (A, B, C, D) and indicate the correct answer.

    Text:
    ${text}`;
        }

        try {
          const resultText = await callGeminiAPI(prompt, imageData);
          quizResult.innerHTML = formatResponse(resultText);
        } catch (error) {
          quizResult.innerHTML = `<p class="text-red-500">${error.message}</p>`;
        } finally {
          quizLoader.classList.add('hidden');
          quizResult.classList.remove('hidden');
          confetti();
        }
      });
    }

    // Gen Z Mode
    const memeInput = document.getElementById('meme-input');
    const memeBtn = document.getElementById('memeBtn');
    const funFactBtn = document.getElementById('funFactBtn');
    const memeGenGameBtn = document.getElementById('meme-gen-game-btn');
    const memeResultsContainer = document.getElementById('meme-results-container');
    const memeLoader = document.getElementById('meme-loader');
    const memeResult = document.getElementById('meme-result');

    if (memeInput) memeInput.addEventListener('input', () => checkInputAndEnableButton('meme'));

    if (memeBtn) {
      memeBtn.addEventListener('click', async () => {
        memeResultsContainer.classList.remove('hidden');
        memeLoader.classList.remove('hidden');
        memeResult.innerHTML = '';
        memeResult.classList.add('hidden');

        let prompt, imageData = null;
        if (memeFileContent.type === 'image') {
          prompt = `You are a witty meme generator. Look at this image and write a short, viral meme caption (max 1-2 lines). Keep it clean but hilarious. Add an optional ‚ÄúTeacher be like‚Äù style if it matches.`;
          imageData = memeFileContent.data;
        } else if (memeFileContent.type === 'text') {
          prompt = `You are a witty meme generator. Based on this text, write a short meme caption (max 1-2 lines). Keep it clean but hilarious.

    Text:
    ${memeFileContent.data}`;
        } else {
          prompt = `You are a witty meme generator. Based on this text, write a short meme caption (max 1-2 lines). Keep it clean but hilarious.

    Text:
    ${memeInput.value}`;
        }

        try {
          const resultText = await callGeminiAPI(prompt, imageData);
          memeResult.innerHTML = formatResponse(resultText);
        } catch (e) {
          memeResult.innerHTML = `<p class="text-red-500">${e.message}</p>`;
        } finally {
          memeLoader.classList.add('hidden');
          memeResult.classList.remove('hidden');
          confetti();
        }
      });
    }
    
    if (funFactBtn) {
      funFactBtn.addEventListener('click', async () => {
        const text = memeInput.value.trim();
        if (!text && memeFileContent.data === null) return;
        
        memeResultsContainer.classList.remove('hidden');
        memeLoader.classList.remove('hidden');
        memeResult.innerHTML = '';
        memeResult.classList.add('hidden');

        let prompt, imageData = null;
        if (memeFileContent.type === 'image') {
          prompt = `Provide a short, interesting, and fun fact based on the content of this image. Keep it to a single sentence.`;
          imageData = memeFileContent.data;
        } else if (memeFileContent.type === 'text') {
          prompt = `Provide a short, interesting, and fun fact based on the following text. Keep it to a single sentence.

    Text:
    ${memeFileContent.data}`;
        } else {
          prompt = `Provide a short, interesting, and fun fact based on the following text. Keep it to a single sentence.

    Text:
    ${text}`;
        }
        try {
          const resultText = await callGeminiAPI(prompt, imageData);
          memeResult.innerHTML = formatResponse(resultText);
        } catch (e) {
          memeResult.innerHTML = `<p class="text-red-500">${e.message}</p>`;
        } finally {
          memeLoader.classList.add('hidden');
          memeResult.classList.remove('hidden');
        }
      });
    }
    
    if (memeGenGameBtn) {
      memeGenGameBtn.addEventListener('click', async () => {
        const context = 'meme';
        const textInput = document.getElementById(`${context}-input`);
        const fileContent = memeFileContent;

        const text = textInput ? textInput.value.trim() : '';
        if (!text && fileContent.data === null) {
            toast("Please provide some content first.", 'error');
            return;
        }

        const prompt = `Based on the following content, extract 8 pairs of a concept/term and its definition/explanation. Respond with a JSON array of objects, with each object having two keys: 'term' and 'definition'. Example: [{"term": "Photosynthesis", "definition": "Process by which plants convert light energy into chemical energy."}]. Keep the definitions concise and clear.`;

        // Prepare the payload based on the content source
        let payload, imageData = null;
        if (fileContent.type === 'image') {
            payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: fileContent.data } }] }] };
        } else if (fileContent.type === 'text') {
            payload = { contents: [{ parts: [{ text: prompt }, { text: `\nText: ${fileContent.data}` }] }] };
        } else {
            payload = { contents: [{ parts: [{ text: prompt }, { text: `\nText: ${text}` }] }] };
        }
        
        payload.generationConfig = {
            responseMimeType: "application/json",
            responseSchema: {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "term": { "type": "STRING" },
                        "definition": { "type": "STRING" }
                    },
                    "propertyOrdering": ["term", "definition"]
                }
            }
        };
        
        switchPanels('panel-games');
        const newGameButton = document.getElementById('memory-newGameBtn');
        if (newGameButton) newGameButton.disabled = true;
        memoryStatus.textContent = "Generating your custom game...";
        memoryGrid.innerHTML = `<div class="mx-auto loader mt-10"></div>`;

        try {
            const termsAndDefinitions = await callGeminiAPI(null, null, payload, true);
            if (termsAndDefinitions && termsAndDefinitions.length === 8) {
                createDynamicMemoryCards(termsAndDefinitions);
                memoryStatus.textContent = "Match the terms with their definitions!";
            } else {
                memoryStatus.textContent = "Failed to generate game. Not enough terms found.";
                initMemoryGame();
            }
        } catch (error) {
            memoryStatus.textContent = `Error: ${error.message}`;
        } finally {
            if (newGameButton) newGameButton.disabled = false;
        }
      });
    }

    // --------------- Tic-Tac-Toe Game Logic ---------------
    const tictactoeCells = document.querySelectorAll('.game-cell');
    const tictactoeStatusText = document.getElementById('tictactoe-status');
    const tictactoeNewGameBtn = document.getElementById('tictactoe-newGameBtn');
    let tictactoeBoardState = ["", "", "", "", "", "", "", "", ""];
    let tictactoeCurrentPlayer = "X";
    let tictactoeGameActive = true;

    const tictactoeWinningConditions = [
        [0, 1, 2], [3, 4, 5], [6, 7, 8],
        [0, 3, 6], [1, 4, 7], [2, 5, 8],
        [0, 4, 8], [2, 4, 6]
    ];

    function handleTictactoeCellPlayed(clickedCell, clickedCellIndex) {
        tictactoeBoardState[clickedCellIndex] = tictactoeCurrentPlayer;
        clickedCell.innerHTML = tictactoeCurrentPlayer;
        clickedCell.disabled = true;
    }

    function handleTictactoePlayerChange() {
        tictactoeCurrentPlayer = tictactoeCurrentPlayer === "X" ? "O" : "X";
        tictactoeStatusText.textContent = `Player ${tictactoeCurrentPlayer}'s turn.`;
    }

    function handleTictactoeResultValidation() {
        let roundWon = false;
        for (let i = 0; i < tictactoeWinningConditions.length; i++) {
            const winCondition = tictactoeWinningConditions[i];
            let a = tictactoeBoardState[winCondition[0]];
            let b = tictactoeBoardState[winCondition[1]];
            let c = tictactoeBoardState[winCondition[2]];
            if (a === "" || b === "" || c === "") {
                continue;
            }
            if (a === b && b === c) {
                roundWon = true;
                break;
            }
        }

        if (roundWon) {
            tictactoeStatusText.textContent = `Player ${tictactoeCurrentPlayer} wins! üéâ`;
            tictactoeGameActive = false;
            confetti();
            return;
        }

        let roundDraw = !tictactoeBoardState.includes("");
        if (roundDraw) {
            tictactoeStatusText.textContent = `It's a draw! üòê`;
            tictactoeGameActive = false;
            return;
        }

        handleTictactoePlayerChange();
    }

    function handleTictactoeCellClick(e) {
        const clickedCell = e.target;
        const clickedCellIndex = parseInt(clickedCell.getAttribute('data-cell-index'));

        if (tictactoeBoardState[clickedCellIndex] !== "" || !tictactoeGameActive) {
            return;
        }

        handleTictactoeCellPlayed(clickedCell, clickedCellIndex);
        handleTictactoeResultValidation();
    }

    function handleNewTictactoeGame() {
        tictactoeGameActive = true;
        tictactoeCurrentPlayer = "X";
        tictactoeBoardState = ["", "", "", "", "", "", "", "", ""];
        tictactoeStatusText.textContent = `Player X's turn.`;
        tictactoeCells.forEach(cell => {
            cell.innerHTML = "";
            cell.disabled = false;
        });
    }
    
    tictactoeCells.forEach(cell => cell.addEventListener('click', handleTictactoeCellClick));
    tictactoeNewGameBtn.addEventListener('click', handleNewTictactoeGame);

    // --------------- Memory Game Logic ---------------
    const memoryGrid = document.getElementById('memory-grid');
    const memoryStatus = document.getElementById('memory-status');
    const memoryNewGameBtn = document.getElementById('memory-newGameBtn');
    
    const cardEmojis = ['üçé', 'üçâ', 'üçá', 'üçì', 'üçí', 'üçë', 'üçä', 'üçç'];
    let cards = [];
    let flippedCards = [];
    let matchedPairs = 0;
    let gameLocked = false;

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }
    function createDynamicMemoryCards(pairs) {
        memoryGrid.innerHTML = '';
        const allCards = [];
        pairs.forEach((pair, index) => {
            // Card for the term
            allCards.push({
                type: 'term',
                value: pair.term,
                pairId: index,
            });
            // Card for the definition
            allCards.push({
                type: 'definition',
                value: pair.definition,
                pairId: index,
            });
        });
        
        shuffle(allCards);
        allCards.forEach((cardData, index) => {
            const cardEl = document.createElement('div');
            cardEl.classList.add('memory-card');
            cardEl.setAttribute('data-pair-id', cardData.pairId);
            cardEl.setAttribute('data-type', cardData.type);
            cardEl.innerHTML = `
                <div class="card-back">üß†</div>
                <div class="card-face p-2 text-sm text-center flex items-center justify-center generated-card">${cardData.value}</div>
            `;
            cardEl.addEventListener('click', () => flipDynamicCard(cardEl));
            memoryGrid.appendChild(cardEl);
        });
    }

    function initMemoryGame() {
        memoryGrid.innerHTML = '';
        cards = [...cardEmojis, ...cardEmojis];
        shuffle(cards);
        flippedCards = [];
        matchedPairs = 0;
        gameLocked = false;
        memoryStatus.textContent = "Find all the matching pairs!";

        cards.forEach((emoji, index) => {
            memoryGrid.appendChild(createCard(emoji, index));
        });
    }

    function createCard(emoji, index) {
        const cardEl = document.createElement('div');
        cardEl.classList.add('memory-card');
        cardEl.setAttribute('data-index', index);
        cardEl.innerHTML = `
          <div class="card-back">üß†</div>
          <div class="card-face">${emoji}</div>
        `;
        cardEl.addEventListener('click', () => flipCard(cardEl, emoji));
        return cardEl;
    }

    function flipCard(card, emoji) {
        if (gameLocked || card.classList.contains('flipped')) {
            return;
        }

        card.classList.add('flipped');
        flippedCards.push({ element: card, emoji: emoji });

        if (flippedCards.length === 2) {
            gameLocked = true;
            setTimeout(checkForMatch, 1000);
        }
    }
    
    function flipDynamicCard(card) {
        if (gameLocked || card.classList.contains('flipped') || card.classList.contains('match')) {
            return;
        }

        card.classList.add('flipped');
        flippedCards.push(card);

        if (flippedCards.length === 2) {
            gameLocked = true;
            setTimeout(checkForDynamicMatch, 1000);
        }
    }
    
    function checkForDynamicMatch() {
        const [card1, card2] = flippedCards;
        
        const pairId1 = card1.getAttribute('data-pair-id');
        const pairId2 = card2.getAttribute('data-pair-id');
        
        if (pairId1 === pairId2) {
            card1.classList.add('match');
            card2.classList.add('match');
            matchedPairs++;
            if (matchedPairs === 8) {
                memoryStatus.textContent = "You won! üéâ";
                confetti();
            }
        } else {
            card1.classList.remove('flipped');
            card2.classList.remove('flipped');
        }
        
        flippedCards = [];
        gameLocked = false;
    }

    function checkForMatch() {
        const [card1, card2] = flippedCards;

        if (card1.emoji === card2.emoji) {
            card1.element.classList.add('match');
            card2.element.classList.add('match');
            matchedPairs++;
            if (matchedPairs === cardEmojis.length) {
                memoryStatus.textContent = "You won! üéâ";
                confetti();
            }
        } else {
            card1.element.classList.remove('flipped');
            card2.element.classList.remove('flipped');
        }
        flippedCards = [];
        gameLocked = false;
    }

    memoryNewGameBtn.addEventListener('click', initMemoryGame);
    document.addEventListener('DOMContentLoaded', initMemoryGame);
    
    // Auto-generate game from content
    const genGameBtns = document.querySelectorAll('[id$="-gen-game-btn"]');
    genGameBtns.forEach(btn => {
        btn.addEventListener('click', async () => {
            const context = btn.id.split('-')[0];
            const textInput = document.getElementById(`${context}-input`);
            const fileContent =
                context === 'ar' ? arFileContent :
                context === 'notes' ? notesFileContent :
                context === 'quiz' ? quizFileContent :
                memeFileContent;

            const text = textInput ? textInput.value.trim() : '';
            if (!text && fileContent.data === null) {
                toast("Please provide some content first.", 'error');
                return;
            }

            const prompt = `Based on the following content, extract 8 pairs of a concept/term and its definition/explanation. Respond with a JSON array of objects, with each object having two keys: 'term' and 'definition'. Example: [{"term": "Photosynthesis", "definition": "Process by which plants convert light energy into chemical energy."}]. Keep the definitions concise and clear.`;

            // Prepare the payload based on the content source
            let payload, imageData = null;
            if (fileContent.type === 'image') {
                payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: fileContent.data } }] }] };
            } else if (fileContent.type === 'text') {
                payload = { contents: [{ parts: [{ text: prompt }, { text: `\nText: ${fileContent.data}` }] }] };
            } else {
                payload = { contents: [{ parts: [{ text: prompt }, { text: `\nText: ${text}` }] }] };
            }
            
            payload.generationConfig = {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "term": { "type": "STRING" },
                            "definition": { "type": "STRING" }
                        },
                        "propertyOrdering": ["term", "definition"]
                    }
                }
            };
            
            switchPanels('panel-games');
            const newGameButton = document.getElementById('memory-newGameBtn');
            if (newGameButton) newGameButton.disabled = true;
            memoryStatus.textContent = "Generating your custom game...";
            memoryGrid.innerHTML = `<div class="mx-auto loader mt-10"></div>`;

            try {
                const termsAndDefinitions = await callGeminiAPI(null, null, payload, true);
                if (termsAndDefinitions && termsAndDefinitions.length === 8) {
                    createDynamicMemoryCards(termsAndDefinitions);
                    memoryStatus.textContent = "Match the terms with their definitions!";
                } else {
                    memoryStatus.textContent = "Failed to generate game. Not enough terms found.";
                    initMemoryGame();
                }
            } catch (error) {
                memoryStatus.textContent = `Error: ${error.message}`;
            } finally {
                if (newGameButton) newGameButton.disabled = false;
            }
        });
    });


    // --------------- Copy buttons ---------------
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.copy-btn');
      if (!btn) return;
      const targetId = btn.getAttribute('data-target');
      const el = document.getElementById(targetId);
      if (!el) return;
      const text = el.innerText;
      navigator.clipboard.writeText(text).then(() => toast('Copied to clipboard'));
    });

    // --------------- Utilities (Markdown-ish formatting) ---------------
    function formatResponse(text) {
      let html = text || '';
      html = html.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/`([^`]+)`/g, '<code class="px-1 py-0.5 rounded bg-slate-100 dark:bg-slate-800">$1</code>');
      html = html.replace(/^(#{1,6})\s*(.+)$/gm, (m, h, t) => {
        const lvl = h.length; const sizes = ['text-2xl','text-xl','text-lg','text-base','text-base','text-base'];
        return `<h${lvl} class="mt-3 mb-1 font-bold ${sizes[lvl-1]}">${t}</h${lvl}>`;
      });
      html = html.replace(/(?:^|\n)[-\*]\s+(.+)(?=\n|$)/g, (m, item) => `<li class="ml-5">${item}</li>`);
      if (/<li/.test(html)) html = html.replace(/(<li[^>]*>.*<\/li>)/gs, '<ul class="list-disc pl-5 space-y-1">$1</ul>');
      html = html.replace(/\n/g, '<br>');
      return html;
    }

    // --------------- Backend: Gemini API (SAME logic + retries). Key is read from localStorage if not hardcoded) ---------------
    async function callGeminiAPI(prompt, imageData = null, customPayload = null, isJson = false) {
      let apiKey = "";
      if (!apiKey) apiKey = localStorage.getItem('gemini_api_key') || "";

      if (!apiKey) {
        const keyError = "API key not found. Add your Google AI API key to localStorage under 'gemini_api_key'.";
        console.error(keyError);
        throw new Error(keyError);
      }

      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
      const payload = customPayload || { contents: [{ parts: [{ text: prompt }] }] };
      if (imageData) payload.contents[0].parts.push({ inlineData: { mimeType: "image/jpeg", data: imageData } });
      
      let response, delay = 1000;
      for (let i = 0; i < 5; i++) {
        try {
          response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (response.ok) {
            const result = await response.json();
            const content = result.candidates && result.candidates[0].content.parts[0].text;
            if (isJson) {
                try {
                    return JSON.parse(content);
                } catch (e) {
                    throw new Error("Failed to parse JSON response from API.");
                }
            }
            if (content) {
              return content;
            }
            throw new Error("Invalid response structure from API.");
          } else if (response.status === 429) {
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2;
          } else {
            const errorBody = await response.json().catch(()=>({error:{message:'Unknown error'}}));
            throw new Error(`API Error: ${errorBody.error?.message || response.statusText}`);
          }
        } catch (error) {
          if (i === 4) throw error;
          await new Promise(resolve => setTimeout(resolve, delay));
          delay *= 2;
        }
      }
      throw new Error("API request failed after multiple retries.");
    }

    // --------------- Confetti (tiny, no deps) ---------------
    function confetti() {
      const c = document.getElementById('confettiCanvas');
      const ctx = c.getContext('2d');
      c.width = window.innerWidth; c.height = window.innerHeight;
      c.classList.remove('hidden');

      const pieces = Array.from({length: 120}).map(() => ({
        x: Math.random()*c.width,
        y: -20 - Math.random()*c.height*0.5,
        r: 3+Math.random()*4,
        a: Math.random()*Math.PI*2,
        v: 2+Math.random()*3,
        s: 0.02+Math.random()*0.03
      }));

      let t = 0;
      function draw(){
        ctx.clearRect(0,0,c.width,c.height);
        pieces.forEach(p => {
          p.y += p.v; p.a += p.s;
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.a);
          ctx.fillStyle = `hsl(${(p.x+p.y)%360}, 90%, 60%)`;
          ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
          ctx.restore();
        });
        t++;
        if (t < 120) requestAnimationFrame(draw);
        else c.classList.add('hidden');
      }
      draw();
    }

    // --------------- Celebrate button (header) triggers confetti sparkle ---------------
    const celebrateBtn = document.getElementById('celebrateBtn');
    if (celebrateBtn) {
      celebrateBtn.addEventListener('click', () => confetti());
    }

    // --------------- Floating help tooltip behavior ---------------
    const helpTooltip = document.getElementById('helpTooltip');
    const helpContent = document.getElementById('helpContent');
    helpTooltip.addEventListener('click', () => {
      if (helpContent.style.display === 'block') {
        helpContent.style.display = 'none';
        helpTooltip.setAttribute('aria-expanded','false');
      } else {
        helpContent.style.display = 'block';
        helpTooltip.setAttribute('aria-expanded','true');
      }
    });

    // --------------- Enable buttons initially ---------------
    ['ar','notes','quiz','meme'].forEach(checkInputAndEnableButton);

    // --------------- Initial icon render ---------------
    refreshIcons();
  </script>
</body>
</html>

